<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>(Experimental) Connection pools</title>
<link rel="stylesheet" href="../../../../../../doc/src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../../index.html" title="Chapter 1. Boost.MySQL">
<link rel="up" href="../examples.html" title="Examples">
<link rel="prev" href="pipeline.html" title="(Experimental) Pipelines">
<link rel="next" href="../tests.html" title="Building and running the tests">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../../boost.png"></td>
<td align="center"><a href="../../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="pipeline.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="../tests.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.examples.connection_pool"></a><a class="link" href="connection_pool.html" title="(Experimental) Connection pools">(Experimental) Connection
      pools</a>
</h3></div></div></div>
<p>
        This example demonstrates how to use <a class="link" href="../ref/boost__mysql__connection_pool.html" title="connection_pool"><code class="literal">connection_pool</code></a>.
        It implements an HTTP REST API server for a text notes application. The API
        provides CRUD methods on note objects. Instead of opening a new MySQL connection
        per HTTP request, the server uses a connection pool to reuse connections.
      </p>
<p>
        The example employs async functions with stackful coroutines.
      </p>
<p>
        This example contains multiple files, and requires linking to <a href="../../../../../../libs/context/index.html" target="_top">Boost.Context</a>,
        <a href="../../../../../../libs/json/index.html" target="_top">Boost.Json</a> and and <a href="../../../../../../libs/url/index.html" target="_top">Boost.Url</a>. This example assumes
        you have gone through the <a class="link" href="../examples.html#mysql.examples.setup">setup</a>.
      </p>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: main.cpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">any_address</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">pool_params</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">detached</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">signal_set</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">thread_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstddef</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdlib</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">memory</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"server.hpp"</span>

<span class="comment">// This example demonstrates how to use a connection_pool.</span>
<span class="comment">// It implements a minimal REST API to manage notes.</span>
<span class="comment">// A note is a simple object containing a user-defined title and content.</span>
<span class="comment">// The REST API offers CRUD operations on such objects:</span>
<span class="comment">//    POST   /notes        Creates a new note.</span>
<span class="comment">//    GET    /notes        Retrieves all notes.</span>
<span class="comment">//    GET    /notes/&lt;id&gt;   Retrieves a single note.</span>
<span class="comment">//    PUT    /notes/&lt;id&gt;   Replaces a note, changing its title and content.</span>
<span class="comment">//    DELETE /notes/&lt;id&gt;   Deletes a note.</span>
<span class="comment">//</span>
<span class="comment">// Notes are stored in MySQL. The note_repository class encapsulates</span>
<span class="comment">//   access to MySQL, offering friendly functions to manipulate notes.</span>
<span class="comment">// server.cpp encapsulates all the boilerplate to launch an HTTP server,</span>
<span class="comment">//   match URLs to API endpoints, and invoke the relevant note_repository functions.</span>
<span class="comment">// All communication happens asynchronously. We use stackful coroutines to simplify</span>
<span class="comment">//   development, using boost::asio::spawn and boost::asio::yield_context.</span>
<span class="comment">//</span>
<span class="comment">// Note: connection_pool is an experimental feature.</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">notes</span><span class="special">;</span>

<span class="comment">// The number of threads to use</span>
<span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">num_threads</span> <span class="special">=</span> <span class="number">5</span><span class="special">;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">argv</span><span class="special">[])</span>
<span class="special">{</span>
    <span class="comment">// Check command line arguments.</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">argc</span> <span class="special">!=</span> <span class="number">5</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"Usage: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">0</span><span class="special">]</span> <span class="special">&lt;&lt;</span> <span class="string">" &lt;username&gt; &lt;password&gt; &lt;mysql-hostname&gt; &lt;port&gt;\n"</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="identifier">EXIT_FAILURE</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Application config</span>
    <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">mysql_username</span> <span class="special">=</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">1</span><span class="special">];</span>
    <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">mysql_password</span> <span class="special">=</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">2</span><span class="special">];</span>
    <span class="keyword">const</span> <span class="keyword">char</span><span class="special">*</span> <span class="identifier">mysql_hostname</span> <span class="special">=</span> <span class="identifier">argv</span><span class="special">[</span><span class="number">3</span><span class="special">];</span>
    <span class="keyword">auto</span> <span class="identifier">port</span> <span class="special">=</span> <span class="keyword">static_cast</span><span class="special">&lt;</span><span class="keyword">unsigned</span> <span class="keyword">short</span><span class="special">&gt;(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">stoi</span><span class="special">(</span><span class="identifier">argv</span><span class="special">[</span><span class="number">4</span><span class="special">]));</span>

    <span class="comment">// An event loop, where the application will run.</span>
    <span class="comment">// We will use the main thread to run the pool, too, so we use</span>
    <span class="comment">// one thread less than configured</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">thread_pool</span> <span class="identifier">th_pool</span><span class="special">(</span><span class="identifier">num_threads</span> <span class="special">-</span> <span class="number">1</span><span class="special">);</span>

    <span class="comment">// Configuration for the connection pool</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pool_params</span> <span class="identifier">pool_prms</span><span class="special">{</span>
        <span class="comment">// Connect using TCP, to the given hostname and using the default port</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">host_and_port</span><span class="special">{</span><span class="identifier">mysql_hostname</span><span class="special">},</span>

        <span class="comment">// Authenticate using the given username</span>
        <span class="identifier">mysql_username</span><span class="special">,</span>

        <span class="comment">// Password for the above username</span>
        <span class="identifier">mysql_password</span><span class="special">,</span>

        <span class="comment">// Database to use when connecting</span>
        <span class="string">"boost_mysql_examples"</span><span class="special">,</span>
    <span class="special">};</span>

    <span class="comment">// Create the connection pool</span>
    <span class="keyword">auto</span> <span class="identifier">shared_st</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_shared</span><span class="special">&lt;</span><span class="identifier">shared_state</span><span class="special">&gt;(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">(</span>
        <span class="comment">// Using thread_safe will create a strand for the connection pool.</span>
        <span class="comment">// This allows us to share the pool between sessions, which may run</span>
        <span class="comment">// concurrently, on different threads.</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pool_executor_params</span><span class="special">::</span><span class="identifier">thread_safe</span><span class="special">(</span><span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">get_executor</span><span class="special">()),</span>

        <span class="comment">// Pool config</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">pool_prms</span><span class="special">)</span>
    <span class="special">));</span>

    <span class="comment">// A signal_set allows us to intercept SIGINT and SIGTERM and</span>
    <span class="comment">// exit gracefully</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">signal_set</span> <span class="identifier">signals</span><span class="special">{</span><span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">get_executor</span><span class="special">(),</span> <span class="identifier">SIGINT</span><span class="special">,</span> <span class="identifier">SIGTERM</span><span class="special">};</span>

    <span class="comment">// Launch the MySQL pool</span>
    <span class="identifier">shared_st</span><span class="special">-&gt;</span><span class="identifier">pool</span><span class="special">.</span><span class="identifier">async_run</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">detached</span><span class="special">);</span>

    <span class="comment">// Start listening for HTTP connections. This will run until the context is stopped</span>
    <span class="keyword">auto</span> <span class="identifier">ec</span> <span class="special">=</span> <span class="identifier">launch_server</span><span class="special">(</span><span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">get_executor</span><span class="special">(),</span> <span class="identifier">shared_st</span><span class="special">,</span> <span class="identifier">port</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">log_error</span><span class="special">(</span><span class="string">"Error launching server: "</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
        <span class="identifier">exit</span><span class="special">(</span><span class="identifier">EXIT_FAILURE</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">// Capture SIGINT and SIGTERM to perform a clean shutdown</span>
    <span class="identifier">signals</span><span class="special">.</span><span class="identifier">async_wait</span><span class="special">([</span><span class="identifier">shared_st</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">th_pool</span><span class="special">](</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span><span class="special">,</span> <span class="keyword">int</span><span class="special">)</span> <span class="special">{</span>
        <span class="comment">// Cancel the pool. This will cause async_run to complete.</span>
        <span class="identifier">shared_st</span><span class="special">-&gt;</span><span class="identifier">pool</span><span class="special">.</span><span class="identifier">cancel</span><span class="special">();</span>

        <span class="comment">// Stop the execution context. This will cause main to exit</span>
        <span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">stop</span><span class="special">();</span>
    <span class="special">});</span>

    <span class="comment">// Attach the current thread to the thread pool. This will block</span>
    <span class="comment">// until stop() is called</span>
    <span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">attach</span><span class="special">();</span>

    <span class="comment">// Wait until all threads have exited</span>
    <span class="identifier">th_pool</span><span class="special">.</span><span class="identifier">join</span><span class="special">();</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Server exiting"</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

    <span class="comment">// (If we get here, it means we got a SIGINT or SIGTERM)</span>
    <span class="keyword">return</span> <span class="identifier">EXIT_SUCCESS</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: types.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">core</span><span class="special">/</span><span class="identifier">span</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">describe</span><span class="special">/</span><span class="keyword">class</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">optional</span><span class="special">/</span><span class="identifier">optional</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">vector</span><span class="special">&gt;</span>

<span class="comment">// Contains type definitions used in the REST API and database code.</span>
<span class="comment">// We use Boost.Describe (BOOST_DESCRIBE_STRUCT) to add reflection</span>
<span class="comment">// capabilities to our types. This allows using Boost.MySQL</span>
<span class="comment">// static interface (i.e. static_results&lt;T&gt;) to parse query results,</span>
<span class="comment">// and Boost.JSON automatic serialization/deserialization.</span>

<span class="keyword">namespace</span> <span class="identifier">notes</span> <span class="special">{</span>

<span class="keyword">struct</span> <span class="identifier">note_t</span>
<span class="special">{</span>
    <span class="comment">// The unique database ID of the object.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">id</span><span class="special">;</span>

    <span class="comment">// The note's title.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">title</span><span class="special">;</span>

    <span class="comment">// The note's actual content.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">content</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">note_t</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">id</span><span class="special">,</span> <span class="identifier">title</span><span class="special">,</span> <span class="identifier">content</span><span class="special">))</span>

<span class="comment">//</span>
<span class="comment">// REST API requests.</span>
<span class="comment">//</span>

<span class="comment">// Used for creating and replacing notes</span>
<span class="keyword">struct</span> <span class="identifier">note_request_body</span>
<span class="special">{</span>
    <span class="comment">// The title that the new note should have.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">title</span><span class="special">;</span>

    <span class="comment">// The content that the new note should have.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">content</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">note_request_body</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">title</span><span class="special">,</span> <span class="identifier">content</span><span class="special">))</span>

<span class="comment">//</span>
<span class="comment">// REST API responses.</span>
<span class="comment">//</span>

<span class="comment">// Used by endpoints returning several notes (like GET /notes).</span>
<span class="keyword">struct</span> <span class="identifier">multi_notes_response</span>
<span class="special">{</span>
    <span class="comment">// The retrieved notes.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">notes</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">multi_notes_response</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">notes</span><span class="special">))</span>

<span class="comment">// Used by endpoints returning a single note (like GET /notes/&lt;id&gt;)</span>
<span class="keyword">struct</span> <span class="identifier">single_note_response</span>
<span class="special">{</span>
    <span class="comment">// The retrieved note.</span>
    <span class="identifier">note_t</span> <span class="identifier">note</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">single_note_response</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">note</span><span class="special">))</span>

<span class="comment">// Used by DELETE /notes/&lt;id&gt;</span>
<span class="keyword">struct</span> <span class="identifier">delete_note_response</span>
<span class="special">{</span>
    <span class="comment">// true if the note was found and deleted, false if the note didn't exist.</span>
    <span class="keyword">bool</span> <span class="identifier">deleted</span><span class="special">;</span>
<span class="special">};</span>
<span class="identifier">BOOST_DESCRIBE_STRUCT</span><span class="special">(</span><span class="identifier">delete_note_response</span><span class="special">,</span> <span class="special">(),</span> <span class="special">(</span><span class="identifier">deleted</span><span class="special">))</span>

<span class="special">}</span>  <span class="comment">// namespace notes</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: repository.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">string_view</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">error</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">spawn</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">optional</span><span class="special">/</span><span class="identifier">optional</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"types.hpp"</span>

<span class="keyword">namespace</span> <span class="identifier">notes</span> <span class="special">{</span>

<span class="keyword">using</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">;</span>
<span class="keyword">using</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">;</span>

<span class="comment">// A lightweight wrapper around a connection_pool that allows</span>
<span class="comment">// creating, updating, retrieving and deleting notes in MySQL.</span>
<span class="comment">// This class encapsulates the database logic.</span>
<span class="comment">// All operations are async, and use stackful coroutines (boost::asio::yield_context).</span>
<span class="comment">// If the database can't be contacted, or unexpected database errors are found,</span>
<span class="comment">// an exception of type boost::mysql::error_with_diagnostics is thrown.</span>
<span class="keyword">class</span> <span class="identifier">note_repository</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool_</span><span class="special">;</span>

<span class="keyword">public</span><span class="special">:</span>
    <span class="comment">// Constructor (this is a cheap-to-construct object)</span>
    <span class="identifier">note_repository</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span><span class="special">&amp;</span> <span class="identifier">pool</span><span class="special">)</span> <span class="special">:</span> <span class="identifier">pool_</span><span class="special">(</span><span class="identifier">pool</span><span class="special">)</span> <span class="special">{}</span>

    <span class="comment">// Retrieves all notes present in the database</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">get_notes</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">);</span>

    <span class="comment">// Retrieves a single note by ID. Returns an empty optional</span>
    <span class="comment">// if no note with the given ID is present in the database.</span>
    <span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">get_note</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">);</span>

    <span class="comment">// Creates a new note in the database with the given components.</span>
    <span class="comment">// Returns the newly created note, including the newly allocated ID.</span>
    <span class="identifier">note_t</span> <span class="identifier">create_note</span><span class="special">(</span><span class="identifier">string_view</span> <span class="identifier">title</span><span class="special">,</span> <span class="identifier">string_view</span> <span class="identifier">content</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">);</span>

    <span class="comment">// Replaces the note identified by note_id, setting its components to the</span>
    <span class="comment">// ones passed. Returns the updated note. If no note with ID matching</span>
    <span class="comment">// note_id can be found, an empty optional is returned.</span>
    <span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">replace_note</span><span class="special">(</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">note_id</span><span class="special">,</span>
        <span class="identifier">string_view</span> <span class="identifier">title</span><span class="special">,</span>
        <span class="identifier">string_view</span> <span class="identifier">content</span><span class="special">,</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span>
    <span class="special">);</span>

    <span class="comment">// Deletes the note identified by note_id. Returns true if</span>
    <span class="comment">// a matching note was deleted, false otherwise.</span>
    <span class="keyword">bool</span> <span class="identifier">delete_note</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">);</span>
<span class="special">};</span>

<span class="special">}</span>  <span class="comment">// namespace notes</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: repository.cpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">diagnostics</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">statement</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">static_results</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">string_view</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">throw_on_error</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iterator</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">tuple</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">utility</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"repository.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"types.hpp"</span>

<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">notes</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">mysql</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">;</span>

<span class="comment">// SQL code to create the notes table is located under $REPO_ROOT/example/db_setup.sql</span>
<span class="comment">// The table looks like this:</span>
<span class="comment">//</span>
<span class="comment">// CREATE TABLE notes(</span>
<span class="comment">//     id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,</span>
<span class="comment">//     title TEXT NOT NULL,</span>
<span class="comment">//     content TEXT NOT NULL</span>
<span class="comment">// );</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">note_repository</span><span class="special">::</span><span class="identifier">get_notes</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">diagnostics</span> <span class="identifier">diag</span><span class="special">;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Get a fresh connection from the pool. This returns a pooled_connection object,</span>
    <span class="comment">// which is a proxy to an any_connection object. Connections are returned to the</span>
    <span class="comment">// pool when the proxy object is destroyed.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pooled_connection</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">(</span><span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Execute the query to retrieve all notes. We use the static interface to</span>
    <span class="comment">// parse results directly into static_results.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">result</span><span class="special">;</span>
    <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span><span class="string">"SELECT id, title, content FROM notes"</span><span class="special">,</span> <span class="identifier">result</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// By default, connections are reset after they are returned to the pool</span>
    <span class="comment">// (by using any_connection::async_reset_connection). This will reset any</span>
    <span class="comment">// session state we changed while we were using the connection</span>
    <span class="comment">// (e.g. it will deallocate any statements we prepared).</span>
    <span class="comment">// We did nothing to mutate session state, so we can tell the pool to skip</span>
    <span class="comment">// this step, providing a minor performance gain.</span>
    <span class="comment">// We use pooled_connection::return_without_reset to do this.</span>
    <span class="identifier">conn</span><span class="special">.</span><span class="identifier">return_without_reset</span><span class="special">();</span>

    <span class="comment">// Move note_t objects into the result vector to save allocations</span>
    <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;(</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_move_iterator</span><span class="special">(</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">begin</span><span class="special">()),</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_move_iterator</span><span class="special">(</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">end</span><span class="special">())</span>
    <span class="special">);</span>
<span class="special">}</span>

<span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">note_repository</span><span class="special">::</span><span class="identifier">get_note</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">diagnostics</span> <span class="identifier">diag</span><span class="special">;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Get a fresh connection from the pool. This returns a pooled_connection object,</span>
    <span class="comment">// which is a proxy to an any_connection object. Connections are returned to the</span>
    <span class="comment">// pool when the proxy object is destroyed.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pooled_connection</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">(</span><span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Our query has a parameter, so we need a prepared statement.</span>
    <span class="comment">// We don't need to deallocate this statement explicitly</span>
    <span class="comment">// (no need to call any_connection::async_close_statement).</span>
    <span class="comment">// The connection pool takes care of this for us</span>
    <span class="comment">// (by using any_connection::async_reset_connection).</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">statement</span> <span class="identifier">stmt</span> <span class="special">=</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_prepare_statement</span><span class="special">(</span>
        <span class="string">"SELECT id, title, content FROM notes WHERE id = ?"</span><span class="special">,</span>
        <span class="identifier">diag</span><span class="special">,</span>
        <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]</span>
    <span class="special">);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Execute the statement. We use the static interface to parse results</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">result</span><span class="special">;</span>
    <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span><span class="identifier">stmt</span><span class="special">.</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">note_id</span><span class="special">),</span> <span class="identifier">result</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// An empty results object indicates that no note was found</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">().</span><span class="identifier">empty</span><span class="special">())</span>
        <span class="keyword">return</span> <span class="special">{};</span>
    <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">rows</span><span class="special">()[</span><span class="number">0</span><span class="special">]);</span>

    <span class="comment">// There's no need to return the connection explicitly to the pool,</span>
    <span class="comment">// pooled_connection's destructor takes care of it.</span>
<span class="special">}</span>

<span class="identifier">note_t</span> <span class="identifier">note_repository</span><span class="special">::</span><span class="identifier">create_note</span><span class="special">(</span><span class="identifier">string_view</span> <span class="identifier">title</span><span class="special">,</span> <span class="identifier">string_view</span> <span class="identifier">content</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">diagnostics</span> <span class="identifier">diag</span><span class="special">;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Get a fresh connection from the pool. This returns a pooled_connection object,</span>
    <span class="comment">// which is a proxy to an any_connection object. Connections are returned to the</span>
    <span class="comment">// pool when the proxy object is destroyed.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pooled_connection</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">(</span><span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Our query has parameters, so we need to prepare a statement.</span>
    <span class="comment">// As explained above, there is no need to deallocate the statement explicitly,</span>
    <span class="comment">// since the pool takes care of it.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">statement</span> <span class="identifier">stmt</span> <span class="special">=</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_prepare_statement</span><span class="special">(</span>
        <span class="string">"INSERT INTO notes (title, content) VALUES (?, ?)"</span><span class="special">,</span>
        <span class="identifier">diag</span><span class="special">,</span>
        <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]</span>
    <span class="special">);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Execute the statement. The statement won't produce any rows,</span>
    <span class="comment">// so we can use static_results&lt;std::tuple&lt;&gt;&gt;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">result</span><span class="special">;</span>
    <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span><span class="identifier">stmt</span><span class="special">.</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">title</span><span class="special">,</span> <span class="identifier">content</span><span class="special">),</span> <span class="identifier">result</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// MySQL reports last_insert_id as a uint64_t regardless of the actual ID type.</span>
    <span class="comment">// Given our table definition, this cast is safe</span>
    <span class="keyword">auto</span> <span class="identifier">new_id</span> <span class="special">=</span> <span class="keyword">static_cast</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span><span class="special">&gt;(</span><span class="identifier">result</span><span class="special">.</span><span class="identifier">last_insert_id</span><span class="special">());</span>

    <span class="keyword">return</span> <span class="identifier">note_t</span><span class="special">{</span><span class="identifier">new_id</span><span class="special">,</span> <span class="identifier">title</span><span class="special">,</span> <span class="identifier">content</span><span class="special">};</span>

    <span class="comment">// There's no need to return the connection explicitly to the pool,</span>
    <span class="comment">// pooled_connection's destructor takes care of it.</span>
<span class="special">}</span>

<span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">note_t</span><span class="special">&gt;</span> <span class="identifier">note_repository</span><span class="special">::</span><span class="identifier">replace_note</span><span class="special">(</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">note_id</span><span class="special">,</span>
    <span class="identifier">string_view</span> <span class="identifier">title</span><span class="special">,</span>
    <span class="identifier">string_view</span> <span class="identifier">content</span><span class="special">,</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">diagnostics</span> <span class="identifier">diag</span><span class="special">;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Get a fresh connection from the pool. This returns a pooled_connection object,</span>
    <span class="comment">// which is a proxy to an any_connection object. Connections are returned to the</span>
    <span class="comment">// pool when the proxy object is destroyed.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pooled_connection</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">(</span><span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Our query has parameters, so we need to prepare a statement.</span>
    <span class="comment">// As explained above, there is no need to deallocate the statement explicitly,</span>
    <span class="comment">// since the pool takes care of it.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">statement</span> <span class="identifier">stmt</span> <span class="special">=</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_prepare_statement</span><span class="special">(</span>
        <span class="string">"UPDATE notes SET title = ?, content = ? WHERE id = ?"</span><span class="special">,</span>
        <span class="identifier">diag</span><span class="special">,</span>
        <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]</span>
    <span class="special">);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Execute the statement. The statement won't produce any rows,</span>
    <span class="comment">// so we can use static_results&lt;std::tuple&lt;&gt;&gt;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">empty_result</span><span class="special">;</span>
    <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span><span class="identifier">stmt</span><span class="special">.</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">title</span><span class="special">,</span> <span class="identifier">content</span><span class="special">,</span> <span class="identifier">note_id</span><span class="special">),</span> <span class="identifier">empty_result</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// No affected rows means that the note doesn't exist</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">empty_result</span><span class="special">.</span><span class="identifier">affected_rows</span><span class="special">()</span> <span class="special">==</span> <span class="number">0u</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="special">{};</span>

    <span class="keyword">return</span> <span class="identifier">note_t</span><span class="special">{</span><span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">title</span><span class="special">,</span> <span class="identifier">content</span><span class="special">};</span>

    <span class="comment">// There's no need to return the connection explicitly to the pool,</span>
    <span class="comment">// pooled_connection's destructor takes care of it.</span>
<span class="special">}</span>

<span class="keyword">bool</span> <span class="identifier">note_repository</span><span class="special">::</span><span class="identifier">delete_note</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span> <span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">diagnostics</span> <span class="identifier">diag</span><span class="special">;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Get a fresh connection from the pool. This returns a pooled_connection object,</span>
    <span class="comment">// which is a proxy to an any_connection object. Connections are returned to the</span>
    <span class="comment">// pool when the proxy object is destroyed.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">pooled_connection</span> <span class="identifier">conn</span> <span class="special">=</span> <span class="identifier">pool_</span><span class="special">.</span><span class="identifier">async_get_connection</span><span class="special">(</span><span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Our query has parameters, so we need to prepare a statement.</span>
    <span class="comment">// As explained above, there is no need to deallocate the statement explicitly,</span>
    <span class="comment">// since the pool takes care of it.</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">statement</span> <span class="identifier">stmt</span> <span class="special">=</span> <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_prepare_statement</span><span class="special">(</span><span class="string">"DELETE FROM notes WHERE id = ?"</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// Execute the statement. The statement won't produce any rows,</span>
    <span class="comment">// so we can use static_results&lt;std::tuple&lt;&gt;&gt;</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">static_results</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">tuple</span><span class="special">&lt;&gt;&gt;</span> <span class="identifier">empty_result</span><span class="special">;</span>
    <span class="identifier">conn</span><span class="special">-&gt;</span><span class="identifier">async_execute</span><span class="special">(</span><span class="identifier">stmt</span><span class="special">.</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">note_id</span><span class="special">),</span> <span class="identifier">empty_result</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
    <span class="identifier">mysql</span><span class="special">::</span><span class="identifier">throw_on_error</span><span class="special">(</span><span class="identifier">ec</span><span class="special">,</span> <span class="identifier">diag</span><span class="special">);</span>

    <span class="comment">// No affected rows means that the note didn't exist</span>
    <span class="keyword">return</span> <span class="identifier">empty_result</span><span class="special">.</span><span class="identifier">affected_rows</span><span class="special">()</span> <span class="special">!=</span> <span class="number">0u</span><span class="special">;</span>

    <span class="comment">// There's no need to return the connection explicitly to the pool,</span>
    <span class="comment">// pooled_connection's destructor takes care of it.</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: handle_request.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">error</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">spawn</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">message</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">string_body</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"repository.hpp"</span>

<span class="keyword">namespace</span> <span class="identifier">notes</span> <span class="special">{</span>

<span class="comment">// Handles an individual HTTP request, producing a response.</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">handle_request</span><span class="special">(</span>
    <span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">request</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&amp;</span> <span class="identifier">request</span><span class="special">,</span>
    <span class="identifier">note_repository</span> <span class="identifier">repo</span><span class="special">,</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span>
<span class="special">);</span>

<span class="special">}</span>  <span class="comment">// namespace notes</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: handle_request.cpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">error_with_diagnostics</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">parse</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">serialize</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">value_from</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">json</span><span class="special">/</span><span class="identifier">value_to</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">optional</span><span class="special">/</span><span class="identifier">optional</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">url</span><span class="special">/</span><span class="identifier">parse</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">variant2</span><span class="special">/</span><span class="identifier">variant</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">exception</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"handle_request.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"repository.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"types.hpp"</span>

<span class="comment">// This file contains all the boilerplate code to dispatch HTTP</span>
<span class="comment">// requests to API endpoints. Functions here end up calling</span>
<span class="comment">// note_repository fuctions.</span>

<span class="keyword">namespace</span> <span class="identifier">asio</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">http</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">;</span>
<span class="keyword">using</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_code</span><span class="special">;</span>
<span class="keyword">using</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">string_view</span><span class="special">;</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">notes</span><span class="special">;</span>

<span class="keyword">namespace</span> <span class="special">{</span>

<span class="comment">// Attempts to parse a numeric ID from a string.</span>
<span class="comment">// If you're using C++17, you can use std::from_chars, instead</span>
<span class="keyword">static</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">int64_t</span><span class="special">&gt;</span> <span class="identifier">parse_id</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">&amp;</span> <span class="identifier">from</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">try</span>
    <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">consumed</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>
        <span class="keyword">int</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">stoi</span><span class="special">(</span><span class="identifier">from</span><span class="special">,</span> <span class="special">&amp;</span><span class="identifier">consumed</span><span class="special">);</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">consumed</span> <span class="special">!=</span> <span class="identifier">from</span><span class="special">.</span><span class="identifier">size</span><span class="special">())</span>
            <span class="keyword">return</span> <span class="special">{};</span>
        <span class="keyword">else</span> <span class="keyword">if</span> <span class="special">(</span><span class="identifier">res</span> <span class="special">&lt;</span> <span class="number">0</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="special">{};</span>
        <span class="keyword">return</span> <span class="identifier">res</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span><span class="special">&amp;)</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="special">{};</span>
    <span class="special">}</span>
<span class="special">}</span>

<span class="comment">// Encapsulates the logic required to match a HTTP request</span>
<span class="comment">// to an API endpoint, call the relevant note_repository function,</span>
<span class="comment">// and return an HTTP response.</span>
<span class="keyword">class</span> <span class="identifier">request_handler</span>
<span class="special">{</span>
    <span class="comment">// The HTTP request we're handling. Requests are small in size,</span>
    <span class="comment">// so we use http::request&lt;http::string_body&gt;</span>
    <span class="keyword">const</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">request</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&amp;</span> <span class="identifier">request_</span><span class="special">;</span>

    <span class="comment">// The repository to access MySQL</span>
    <span class="identifier">note_repository</span> <span class="identifier">repo_</span><span class="special">;</span>

    <span class="comment">// Creates an error response</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span> <span class="identifier">code</span><span class="special">,</span> <span class="identifier">string_view</span> <span class="identifier">msg</span><span class="special">)</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">res</span><span class="special">;</span>

        <span class="comment">// Set the status code</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">result</span><span class="special">(</span><span class="identifier">code</span><span class="special">);</span>

        <span class="comment">// Set the keep alive option</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">keep_alive</span><span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">keep_alive</span><span class="special">());</span>

        <span class="comment">// Set the body</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">body</span><span class="special">()</span> <span class="special">=</span> <span class="identifier">msg</span><span class="special">;</span>

        <span class="comment">// Adjust the content-length field</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">prepare_payload</span><span class="special">();</span>

        <span class="comment">// Done</span>
        <span class="keyword">return</span> <span class="identifier">res</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Used when the request's Content-Type header doesn't match what we expect</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">invalid_content_type</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">bad_request</span><span class="special">,</span> <span class="string">"Invalid content-type"</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">// Used when the request body didn't match the format we expect</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">invalid_body</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">bad_request</span><span class="special">,</span> <span class="string">"Invalid body"</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">// Used when the request's method didn't match the ones allowed by the endpoint</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">method_not_allowed</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">method_not_allowed</span><span class="special">,</span> <span class="string">"Method not allowed"</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">// Used when the request target couldn't be matched to any API endpoint</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">endpoint_not_found</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">,</span> <span class="string">"The requested resource was not found"</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">// Used when the user requested a note (e.g. using GET /note/&lt;id&gt; or PUT /note/&lt;id&gt;)</span>
    <span class="comment">// but the note doesn't exist</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">note_not_found</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">not_found</span><span class="special">,</span> <span class="string">"The requested note was not found"</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="comment">// Creates a response with a serialized JSON body.</span>
    <span class="comment">// T should be a type with Boost.Describe metadata containing the</span>
    <span class="comment">// body data to be serialized</span>
    <span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">T</span><span class="special">&gt;</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">json_response</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">T</span><span class="special">&amp;</span> <span class="identifier">body</span><span class="special">)</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">res</span><span class="special">;</span>

        <span class="comment">// A JSON response is always a 200</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">result</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">ok</span><span class="special">);</span>

        <span class="comment">// Set the content-type header</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">set</span><span class="special">(</span><span class="string">"Content-Type"</span><span class="special">,</span> <span class="string">"application/json"</span><span class="special">);</span>

        <span class="comment">// Set the keep-alive option</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">keep_alive</span><span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">keep_alive</span><span class="special">());</span>

        <span class="comment">// Serialize the body data into a string and use it as the response body.</span>
        <span class="comment">// We use Boost.JSON's automatic serialization feature, which uses Boost.Describe</span>
        <span class="comment">// reflection data to generate a serialization function for us.</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">body</span><span class="special">()</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">serialize</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">value_from</span><span class="special">(</span><span class="identifier">body</span><span class="special">));</span>

        <span class="comment">// Adjust the content-length header</span>
        <span class="identifier">res</span><span class="special">.</span><span class="identifier">prepare_payload</span><span class="special">();</span>

        <span class="comment">// Done</span>
        <span class="keyword">return</span> <span class="identifier">res</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Returns true if the request's Content-Type is set to JSON</span>
    <span class="keyword">bool</span> <span class="identifier">has_json_content_type</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="keyword">auto</span> <span class="identifier">it</span> <span class="special">=</span> <span class="identifier">request_</span><span class="special">.</span><span class="identifier">find</span><span class="special">(</span><span class="string">"Content-Type"</span><span class="special">);</span>
        <span class="keyword">return</span> <span class="identifier">it</span> <span class="special">!=</span> <span class="identifier">request_</span><span class="special">.</span><span class="identifier">end</span><span class="special">()</span> <span class="special">&amp;&amp;</span> <span class="identifier">it</span><span class="special">-&gt;</span><span class="identifier">value</span><span class="special">()</span> <span class="special">==</span> <span class="string">"application/json"</span><span class="special">;</span>
    <span class="special">}</span>

    <span class="comment">// Attempts to parse the request body as a JSON into an object of type T.</span>
    <span class="comment">// T should be a type with Boost.Describe metadata.</span>
    <span class="comment">// We use boost::system::result, which may contain a result or an error.</span>
    <span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">T</span><span class="special">&gt;</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">result</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;</span> <span class="identifier">parse_json_request</span><span class="special">()</span> <span class="keyword">const</span>
    <span class="special">{</span>
        <span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

        <span class="comment">// Attempt to parse the request into a json::value.</span>
        <span class="comment">// This will fail if the provided body isn't valid JSON.</span>
        <span class="keyword">auto</span> <span class="identifier">val</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">parse</span><span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">body</span><span class="special">(),</span> <span class="identifier">ec</span><span class="special">);</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="identifier">ec</span><span class="special">;</span>

        <span class="comment">// Attempt to parse the json::value into a T. This will</span>
        <span class="comment">// fail if the provided JSON doesn't match T's shape.</span>
        <span class="keyword">return</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">json</span><span class="special">::</span><span class="identifier">try_value_to</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;(</span><span class="identifier">val</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">handle_request_impl</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">// Parse the request target. We use Boost.Url to do this.</span>
        <span class="keyword">auto</span> <span class="identifier">url</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">urls</span><span class="special">::</span><span class="identifier">parse_origin_form</span><span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">target</span><span class="special">());</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">url</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
            <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">bad_request</span><span class="special">,</span> <span class="string">"Invalid request target"</span><span class="special">);</span>

        <span class="comment">// We will be iterating over the target's segments to determine</span>
        <span class="comment">// which endpoint we are being requested</span>
        <span class="keyword">auto</span> <span class="identifier">segs</span> <span class="special">=</span> <span class="identifier">url</span><span class="special">-&gt;</span><span class="identifier">segments</span><span class="special">();</span>
        <span class="keyword">auto</span> <span class="identifier">segit</span> <span class="special">=</span> <span class="identifier">segs</span><span class="special">.</span><span class="identifier">begin</span><span class="special">();</span>
        <span class="keyword">auto</span> <span class="identifier">seg</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">segit</span><span class="special">++;</span>

        <span class="comment">// All endpoints start with /notes</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">seg</span> <span class="special">!=</span> <span class="string">"notes"</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="identifier">endpoint_not_found</span><span class="special">();</span>

        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">segit</span> <span class="special">==</span> <span class="identifier">segs</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
        <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">method</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">get</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// GET /notes: retrieves all the notes.</span>
                <span class="comment">// The request doesn't have a body.</span>
                <span class="comment">// The response has a JSON body with multi_notes_response format</span>
                <span class="keyword">auto</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">repo_</span><span class="special">.</span><span class="identifier">get_notes</span><span class="special">(</span><span class="identifier">yield</span><span class="special">);</span>
                <span class="keyword">return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">multi_notes_response</span><span class="special">{</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">res</span><span class="special">)});</span>
            <span class="special">}</span>
            <span class="keyword">else</span> <span class="keyword">if</span> <span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">method</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">post</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// POST /notes: creates a note.</span>
                <span class="comment">// The request has a JSON body with note_request_body format.</span>
                <span class="comment">// The response has a JSON body with single_note_response format.</span>

                <span class="comment">// Parse the request body</span>
                <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">has_json_content_type</span><span class="special">())</span>
                    <span class="keyword">return</span> <span class="identifier">invalid_content_type</span><span class="special">();</span>
                <span class="keyword">auto</span> <span class="identifier">args</span> <span class="special">=</span> <span class="identifier">parse_json_request</span><span class="special">&lt;</span><span class="identifier">note_request_body</span><span class="special">&gt;();</span>
                <span class="keyword">if</span> <span class="special">(</span><span class="identifier">args</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
                    <span class="keyword">return</span> <span class="identifier">invalid_body</span><span class="special">();</span>

                <span class="comment">// Actually create the note</span>
                <span class="keyword">auto</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">repo_</span><span class="special">.</span><span class="identifier">create_note</span><span class="special">(</span><span class="identifier">args</span><span class="special">-&gt;</span><span class="identifier">title</span><span class="special">,</span> <span class="identifier">args</span><span class="special">-&gt;</span><span class="identifier">content</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">);</span>

                <span class="comment">// Return the newly crated note as response</span>
                <span class="keyword">return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">single_note_response</span><span class="special">{</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">res</span><span class="special">)});</span>
            <span class="special">}</span>
            <span class="keyword">else</span>
            <span class="special">{</span>
                <span class="keyword">return</span> <span class="identifier">method_not_allowed</span><span class="special">();</span>
            <span class="special">}</span>
        <span class="special">}</span>
        <span class="keyword">else</span>
        <span class="special">{</span>
            <span class="comment">// The URL has the form /notes/&lt;note-id&gt;. Parse the note ID.</span>
            <span class="keyword">auto</span> <span class="identifier">note_id</span> <span class="special">=</span> <span class="identifier">parse_id</span><span class="special">(*</span><span class="identifier">segit</span><span class="special">++);</span>
            <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">note_id</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
            <span class="special">{</span>
                <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span>
                    <span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">bad_request</span><span class="special">,</span>
                    <span class="string">"Invalid note_id specified in request target"</span>
                <span class="special">);</span>
            <span class="special">}</span>

            <span class="comment">// /notes/&lt;note-id&gt;/&lt;something-else&gt; is not a valid endpoint</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">segit</span> <span class="special">!=</span> <span class="identifier">segs</span><span class="special">.</span><span class="identifier">end</span><span class="special">())</span>
                <span class="keyword">return</span> <span class="identifier">endpoint_not_found</span><span class="special">();</span>

            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">method</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">get</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// GET /notes/&lt;note-id&gt;: retrieves a single note.</span>
                <span class="comment">// The request doesn't have a body.</span>
                <span class="comment">// The response has a JSON body with single_note_response format</span>

                <span class="comment">// Get the note</span>
                <span class="keyword">auto</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">repo_</span><span class="special">.</span><span class="identifier">get_note</span><span class="special">(*</span><span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">);</span>

                <span class="comment">// If we didn't find it, return a 404 error</span>
                <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
                    <span class="keyword">return</span> <span class="identifier">note_not_found</span><span class="special">();</span>

                <span class="comment">// Return it as response</span>
                <span class="keyword">return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">single_note_response</span><span class="special">{</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(*</span><span class="identifier">res</span><span class="special">)});</span>
            <span class="special">}</span>
            <span class="keyword">else</span> <span class="keyword">if</span> <span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">method</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">put</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// PUT /notes/&lt;note-id&gt;: replaces a note.</span>
                <span class="comment">// The request has a JSON body with note_request_body format.</span>
                <span class="comment">// The response has a JSON body with single_note_response format.</span>

                <span class="comment">// Parse the JSON body</span>
                <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">has_json_content_type</span><span class="special">())</span>
                    <span class="keyword">return</span> <span class="identifier">invalid_content_type</span><span class="special">();</span>
                <span class="keyword">auto</span> <span class="identifier">args</span> <span class="special">=</span> <span class="identifier">parse_json_request</span><span class="special">&lt;</span><span class="identifier">note_request_body</span><span class="special">&gt;();</span>
                <span class="keyword">if</span> <span class="special">(</span><span class="identifier">args</span><span class="special">.</span><span class="identifier">has_error</span><span class="special">())</span>
                    <span class="keyword">return</span> <span class="identifier">invalid_body</span><span class="special">();</span>

                <span class="comment">// Perform the update</span>
                <span class="keyword">auto</span> <span class="identifier">res</span> <span class="special">=</span> <span class="identifier">repo_</span><span class="special">.</span><span class="identifier">replace_note</span><span class="special">(*</span><span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">args</span><span class="special">-&gt;</span><span class="identifier">title</span><span class="special">,</span> <span class="identifier">args</span><span class="special">-&gt;</span><span class="identifier">content</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">);</span>

                <span class="comment">// Check that it took effect. Otherwise, it's because the note wasn't there</span>
                <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">res</span><span class="special">.</span><span class="identifier">has_value</span><span class="special">())</span>
                    <span class="keyword">return</span> <span class="identifier">note_not_found</span><span class="special">();</span>

                <span class="comment">// Return the updated note as response</span>
                <span class="keyword">return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">single_note_response</span><span class="special">{</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(*</span><span class="identifier">res</span><span class="special">)});</span>
            <span class="special">}</span>
            <span class="keyword">else</span> <span class="keyword">if</span> <span class="special">(</span><span class="identifier">request_</span><span class="special">.</span><span class="identifier">method</span><span class="special">()</span> <span class="special">==</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">verb</span><span class="special">::</span><span class="identifier">delete_</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// DELETE /notes/&lt;note-id&gt;: deletes a note.</span>
                <span class="comment">// The request doesn't have a body.</span>
                <span class="comment">// The response has a JSON body with delete_note_response format.</span>

                <span class="comment">// Attempt to delete the note</span>
                <span class="keyword">bool</span> <span class="identifier">deleted</span> <span class="special">=</span> <span class="identifier">repo_</span><span class="special">.</span><span class="identifier">delete_note</span><span class="special">(*</span><span class="identifier">note_id</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">);</span>

                <span class="comment">// Return whether the delete was successful in the response.</span>
                <span class="comment">// We don't fail DELETEs for notes that don't exist.</span>
                <span class="keyword">return</span> <span class="identifier">json_response</span><span class="special">(</span><span class="identifier">delete_note_response</span><span class="special">{</span><span class="identifier">deleted</span><span class="special">});</span>
            <span class="special">}</span>
            <span class="keyword">else</span>
            <span class="special">{</span>
                <span class="keyword">return</span> <span class="identifier">method_not_allowed</span><span class="special">();</span>
            <span class="special">}</span>
        <span class="special">}</span>
    <span class="special">}</span>

<span class="keyword">public</span><span class="special">:</span>
    <span class="comment">// Constructor</span>
    <span class="identifier">request_handler</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">request</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&amp;</span> <span class="identifier">req</span><span class="special">,</span> <span class="identifier">note_repository</span> <span class="identifier">repo</span><span class="special">)</span>
        <span class="special">:</span> <span class="identifier">request_</span><span class="special">(</span><span class="identifier">req</span><span class="special">),</span> <span class="identifier">repo_</span><span class="special">(</span><span class="identifier">repo</span><span class="special">)</span>
    <span class="special">{</span>
    <span class="special">}</span>

    <span class="comment">// Generates a response for the request passed to the constructor</span>
    <span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">handle_request</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="keyword">try</span>
        <span class="special">{</span>
            <span class="comment">// Attempt to handle the request</span>
            <span class="keyword">return</span> <span class="identifier">handle_request_impl</span><span class="special">(</span><span class="identifier">yield</span><span class="special">);</span>
        <span class="special">}</span>
        <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_with_diagnostics</span><span class="special">&amp;</span> <span class="identifier">err</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="comment">// A Boost.MySQL error. This will happen if you don't have connectivity</span>
            <span class="comment">// to your database, your schema is incorrect or your credentials are invalid.</span>
            <span class="comment">// Log the error, including diagnostics, and return a generic 500</span>
            <span class="identifier">log_error</span><span class="special">(</span>
                <span class="string">"Uncaught exception: "</span><span class="special">,</span>
                <span class="identifier">err</span><span class="special">.</span><span class="identifier">what</span><span class="special">(),</span>
                <span class="string">"\nServer diagnostics: "</span><span class="special">,</span>
                <span class="identifier">err</span><span class="special">.</span><span class="identifier">get_diagnostics</span><span class="special">().</span><span class="identifier">server_message</span><span class="special">()</span>
            <span class="special">);</span>
            <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">internal_server_error</span><span class="special">,</span> <span class="string">"Internal error"</span><span class="special">);</span>
        <span class="special">}</span>
        <span class="keyword">catch</span> <span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">exception</span><span class="special">&amp;</span> <span class="identifier">err</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="comment">// Another kind of error. This indicates a programming error or a severe</span>
            <span class="comment">// server condition (e.g. out of memory). Same procedure as above.</span>
            <span class="identifier">log_error</span><span class="special">(</span><span class="string">"Uncaught exception: "</span><span class="special">,</span> <span class="identifier">err</span><span class="special">.</span><span class="identifier">what</span><span class="special">());</span>
            <span class="keyword">return</span> <span class="identifier">error_response</span><span class="special">(</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">status</span><span class="special">::</span><span class="identifier">internal_server_error</span><span class="special">,</span> <span class="string">"Internal error"</span><span class="special">);</span>
        <span class="special">}</span>
    <span class="special">}</span>
<span class="special">};</span>

<span class="special">}</span>  <span class="comment">// namespace</span>

<span class="comment">// External interface</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">response</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">notes</span><span class="special">::</span><span class="identifier">handle_request</span><span class="special">(</span>
    <span class="keyword">const</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">request</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;&amp;</span> <span class="identifier">request</span><span class="special">,</span>
    <span class="identifier">note_repository</span> <span class="identifier">repo</span><span class="special">,</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">request_handler</span><span class="special">(</span><span class="identifier">request</span><span class="special">,</span> <span class="identifier">repo</span><span class="special">).</span><span class="identifier">handle_request</span><span class="special">(</span><span class="identifier">yield</span><span class="special">);</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: server.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">any_io_executor</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">io_context</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">memory</span><span class="special">&gt;</span>

<span class="keyword">namespace</span> <span class="identifier">notes</span> <span class="special">{</span>

<span class="comment">// State shared by all sessions created by our server.</span>
<span class="comment">// For this application, we only need a connection_pool object.</span>
<span class="comment">// Place here any other singleton objects your application may need.</span>
<span class="comment">// We will use std::shared_ptr&lt;shared_state&gt; to ensure that objects</span>
<span class="comment">// are kept alive until all sessions are terminated.</span>
<span class="keyword">struct</span> <span class="identifier">shared_state</span>
<span class="special">{</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span> <span class="identifier">pool</span><span class="special">;</span>

    <span class="identifier">shared_state</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">connection_pool</span> <span class="identifier">pool</span><span class="special">)</span> <span class="special">:</span> <span class="identifier">pool</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">pool</span><span class="special">))</span> <span class="special">{}</span>
<span class="special">};</span>

<span class="comment">// Launches a HTTP server that will listen on 0.0.0.0:port.</span>
<span class="comment">// If the server fails to launch (e.g. because the port is aleady in use),</span>
<span class="comment">// returns a non-zero error code. ex should identify the io_context or thread_pool</span>
<span class="comment">// where the server should run. The server is run until the underlying execution</span>
<span class="comment">// context is stopped.</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">launch_server</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">any_io_executor</span> <span class="identifier">ex</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">shared_state</span><span class="special">&gt;</span> <span class="identifier">state</span><span class="special">,</span>
    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="identifier">port</span>
<span class="special">);</span>

<span class="special">}</span>  <span class="comment">// namespace notes</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: server.cpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">connection_pool</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">mysql</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">any_io_executor</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">ip</span><span class="special">/</span><span class="identifier">address</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">ip</span><span class="special">/</span><span class="identifier">tcp</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">spawn</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">asio</span><span class="special">/</span><span class="identifier">strand</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">core</span><span class="special">/</span><span class="identifier">flat_buffer</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">error</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">message</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">parser</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">read</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">string_body</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">beast</span><span class="special">/</span><span class="identifier">http</span><span class="special">/</span><span class="identifier">write</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstddef</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdlib</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">exception</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">memory</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="string">"handle_request.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"repository.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"server.hpp"</span>
<span class="preprocessor">#include</span> <span class="string">"types.hpp"</span>

<span class="comment">// This file contains all the boilerplate code to implement a HTTP</span>
<span class="comment">// server. Functions here end up invoking handle_request.</span>

<span class="keyword">namespace</span> <span class="identifier">asio</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">;</span>
<span class="keyword">namespace</span> <span class="identifier">http</span> <span class="special">=</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">http</span><span class="special">;</span>
<span class="keyword">using</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">mysql</span><span class="special">::</span><span class="identifier">error_code</span><span class="special">;</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">notes</span><span class="special">;</span>

<span class="keyword">namespace</span> <span class="special">{</span>

<span class="keyword">static</span> <span class="keyword">void</span> <span class="identifier">run_http_session</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span> <span class="identifier">sock</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">shared_state</span><span class="special">&gt;</span> <span class="identifier">st</span><span class="special">,</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// A buffer to read incoming client requests</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">beast</span><span class="special">::</span><span class="identifier">flat_buffer</span> <span class="identifier">buff</span><span class="special">;</span>

    <span class="keyword">while</span> <span class="special">(</span><span class="keyword">true</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="comment">// Construct a new parser for each message</span>
        <span class="identifier">http</span><span class="special">::</span><span class="identifier">request_parser</span><span class="special">&lt;</span><span class="identifier">http</span><span class="special">::</span><span class="identifier">string_body</span><span class="special">&gt;</span> <span class="identifier">parser</span><span class="special">;</span>

        <span class="comment">// Apply a reasonable limit to the allowed size</span>
        <span class="comment">// of the body in bytes to prevent abuse.</span>
        <span class="identifier">parser</span><span class="special">.</span><span class="identifier">body_limit</span><span class="special">(</span><span class="number">10000</span><span class="special">);</span>

        <span class="comment">// Read a request</span>
        <span class="identifier">http</span><span class="special">::</span><span class="identifier">async_read</span><span class="special">(</span><span class="identifier">sock</span><span class="special">,</span> <span class="identifier">buff</span><span class="special">,</span> <span class="identifier">parser</span><span class="special">.</span><span class="identifier">get</span><span class="special">(),</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>

        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span> <span class="special">==</span> <span class="identifier">http</span><span class="special">::</span><span class="identifier">error</span><span class="special">::</span><span class="identifier">end_of_stream</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// This means they closed the connection</span>
                <span class="identifier">sock</span><span class="special">.</span><span class="identifier">shutdown</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span><span class="special">::</span><span class="identifier">shutdown_send</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
            <span class="special">}</span>
            <span class="keyword">else</span>
            <span class="special">{</span>
                <span class="comment">// An unknown error happened</span>
                <span class="identifier">log_error</span><span class="special">(</span><span class="string">"Error reading HTTP request: "</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
            <span class="special">}</span>
            <span class="keyword">return</span><span class="special">;</span>
        <span class="special">}</span>

        <span class="comment">// Process the request to generate a response.</span>
        <span class="comment">// This invokes the business logic, which will need to access MySQL data</span>
        <span class="keyword">auto</span> <span class="identifier">response</span> <span class="special">=</span> <span class="identifier">handle_request</span><span class="special">(</span><span class="identifier">parser</span><span class="special">.</span><span class="identifier">get</span><span class="special">(),</span> <span class="identifier">note_repository</span><span class="special">(</span><span class="identifier">st</span><span class="special">-&gt;</span><span class="identifier">pool</span><span class="special">),</span> <span class="identifier">yield</span><span class="special">);</span>

        <span class="comment">// Determine if we should close the connection</span>
        <span class="keyword">bool</span> <span class="identifier">keep_alive</span> <span class="special">=</span> <span class="identifier">response</span><span class="special">.</span><span class="identifier">keep_alive</span><span class="special">();</span>

        <span class="comment">// Send the response</span>
        <span class="identifier">http</span><span class="special">::</span><span class="identifier">async_write</span><span class="special">(</span><span class="identifier">sock</span><span class="special">,</span> <span class="identifier">response</span><span class="special">,</span> <span class="identifier">yield</span><span class="special">[</span><span class="identifier">ec</span><span class="special">]);</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="identifier">log_error</span><span class="special">(</span><span class="string">"Error writing HTTP response: "</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>

        <span class="comment">// This means we should close the connection, usually because</span>
        <span class="comment">// the response indicated the "Connection: close" semantic.</span>
        <span class="keyword">if</span> <span class="special">(!</span><span class="identifier">keep_alive</span><span class="special">)</span>
        <span class="special">{</span>
            <span class="identifier">sock</span><span class="special">.</span><span class="identifier">shutdown</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span><span class="special">::</span><span class="identifier">shutdown_send</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
            <span class="keyword">return</span><span class="special">;</span>
        <span class="special">}</span>
    <span class="special">}</span>
<span class="special">}</span>

<span class="comment">// Implements the server's accept loop. The server will</span>
<span class="comment">// listen for connections until stopped.</span>
<span class="keyword">static</span> <span class="keyword">void</span> <span class="identifier">do_accept</span><span class="special">(</span>
    <span class="identifier">asio</span><span class="special">::</span><span class="identifier">any_io_executor</span> <span class="identifier">executor</span><span class="special">,</span>  <span class="comment">// The original executor (without strands)</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">acceptor</span><span class="special">&gt;</span> <span class="identifier">acceptor</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">shared_state</span><span class="special">&gt;</span> <span class="identifier">st</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">acceptor</span><span class="special">-&gt;</span><span class="identifier">async_accept</span><span class="special">([</span><span class="identifier">executor</span><span class="special">,</span> <span class="identifier">st</span><span class="special">,</span> <span class="identifier">acceptor</span><span class="special">](</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">,</span> <span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">socket</span> <span class="identifier">sock</span><span class="special">)</span> <span class="special">{</span>
        <span class="comment">// If there was an error accepting the connection, exit our loop</span>
        <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
            <span class="keyword">return</span> <span class="identifier">log_error</span><span class="special">(</span><span class="string">"Error while accepting connection"</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>

        <span class="comment">// Launch a new session for this connection. Each session gets its</span>
        <span class="comment">// own stackful coroutine, so we can get back to listening for new connections.</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">spawn</span><span class="special">(</span>
            <span class="comment">// Every session gets its own strand. This prevents data races.</span>
            <span class="identifier">asio</span><span class="special">::</span><span class="identifier">make_strand</span><span class="special">(</span><span class="identifier">executor</span><span class="special">),</span>

            <span class="comment">// The actual coroutine</span>
            <span class="special">[</span><span class="identifier">st</span><span class="special">,</span> <span class="identifier">socket</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">sock</span><span class="special">)](</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">yield_context</span> <span class="identifier">yield</span><span class="special">)</span> <span class="keyword">mutable</span> <span class="special">{</span>
                <span class="identifier">run_http_session</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">socket</span><span class="special">),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">st</span><span class="special">),</span> <span class="identifier">yield</span><span class="special">);</span>
            <span class="special">},</span>

            <span class="comment">// All errors in the session are handled via error codes or by catching</span>
            <span class="comment">// exceptions explicitly. An unhandled exception here means an error.</span>
            <span class="comment">// Rethrowing it will propagate the exception, making io_context::run()</span>
            <span class="comment">// to throw and terminate the program.</span>
            <span class="special">[](</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">exception_ptr</span> <span class="identifier">ex</span><span class="special">)</span> <span class="special">{</span>
                <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ex</span><span class="special">)</span>
                    <span class="identifier">std</span><span class="special">::</span><span class="identifier">rethrow_exception</span><span class="special">(</span><span class="identifier">ex</span><span class="special">);</span>
            <span class="special">}</span>
        <span class="special">);</span>

        <span class="comment">// Accept a new connection</span>
        <span class="identifier">do_accept</span><span class="special">(</span><span class="identifier">executor</span><span class="special">,</span> <span class="identifier">acceptor</span><span class="special">,</span> <span class="identifier">st</span><span class="special">);</span>
    <span class="special">});</span>
<span class="special">}</span>

<span class="special">}</span>  <span class="comment">// namespace</span>

<span class="identifier">error_code</span> <span class="identifier">notes</span><span class="special">::</span><span class="identifier">launch_server</span><span class="special">(</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">any_io_executor</span> <span class="identifier">ex</span><span class="special">,</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">shared_state</span><span class="special">&gt;</span> <span class="identifier">st</span><span class="special">,</span>
    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="identifier">port</span>
<span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// An object that allows us to acept incoming TCP connections.</span>
    <span class="comment">// Since we're in a multi-threaded environment, we create a strand for the acceptor,</span>
    <span class="comment">// so all accept handlers are run serialized</span>
    <span class="keyword">auto</span> <span class="identifier">acceptor</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_shared</span><span class="special">&lt;</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">acceptor</span><span class="special">&gt;(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">make_strand</span><span class="special">(</span><span class="identifier">ex</span><span class="special">));</span>

    <span class="comment">// The endpoint where the server will listen. Edit this if you want to</span>
    <span class="comment">// change the address or port we bind to.</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">tcp</span><span class="special">::</span><span class="identifier">endpoint</span> <span class="identifier">listening_endpoint</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">ip</span><span class="special">::</span><span class="identifier">make_address</span><span class="special">(</span><span class="string">"0.0.0.0"</span><span class="special">),</span> <span class="identifier">port</span><span class="special">);</span>

    <span class="comment">// Open the acceptor</span>
    <span class="identifier">acceptor</span><span class="special">-&gt;</span><span class="identifier">open</span><span class="special">(</span><span class="identifier">listening_endpoint</span><span class="special">.</span><span class="identifier">protocol</span><span class="special">(),</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Allow address reuse</span>
    <span class="identifier">acceptor</span><span class="special">-&gt;</span><span class="identifier">set_option</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">socket_base</span><span class="special">::</span><span class="identifier">reuse_address</span><span class="special">(</span><span class="keyword">true</span><span class="special">),</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Bind to the server address</span>
    <span class="identifier">acceptor</span><span class="special">-&gt;</span><span class="identifier">bind</span><span class="special">(</span><span class="identifier">listening_endpoint</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// Start listening for connections</span>
    <span class="identifier">acceptor</span><span class="special">-&gt;</span><span class="identifier">listen</span><span class="special">(</span><span class="identifier">asio</span><span class="special">::</span><span class="identifier">socket_base</span><span class="special">::</span><span class="identifier">max_listen_connections</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">ec</span><span class="special">)</span>
        <span class="keyword">return</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Server listening at "</span> <span class="special">&lt;&lt;</span> <span class="identifier">acceptor</span><span class="special">-&gt;</span><span class="identifier">local_endpoint</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>

    <span class="comment">// Launch the acceptor loop</span>
    <span class="identifier">do_accept</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">ex</span><span class="special">),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">acceptor</span><span class="special">),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">st</span><span class="special">));</span>

    <span class="comment">// Done</span>
    <span class="keyword">return</span> <span class="identifier">error_code</span><span class="special">();</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="comment">//</span>
<span class="comment">// File: log_error.hpp</span>
<span class="comment">//</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">mutex</span><span class="special">&gt;</span>

<span class="comment">// Helper function to safely write diagnostics to std::cerr.</span>
<span class="comment">// Since we're in a multi-threaded environment, directly writing to std::cerr</span>
<span class="comment">// can lead to interleaved output, so we should synchronize calls with a mutex.</span>
<span class="comment">// This function is only called in rare cases (e.g. unhandled exceptions),</span>
<span class="comment">// so we can afford the synchronization overhead.</span>

<span class="keyword">namespace</span> <span class="identifier">notes</span> <span class="special">{</span>

<span class="comment">// If you're in C++17+, you can write this using fold expressions</span>
<span class="comment">// instead of recursion.</span>
<span class="keyword">inline</span> <span class="keyword">void</span> <span class="identifier">log_error_impl</span><span class="special">()</span> <span class="special">{}</span>

<span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">class</span> <span class="identifier">Arg1</span><span class="special">,</span> <span class="keyword">class</span><span class="special">...</span> <span class="identifier">Tail</span><span class="special">&gt;</span>
<span class="keyword">void</span> <span class="identifier">log_error_impl</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">Arg1</span><span class="special">&amp;</span> <span class="identifier">arg</span><span class="special">,</span> <span class="keyword">const</span> <span class="identifier">Tail</span><span class="special">&amp;...</span> <span class="identifier">tail</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="identifier">arg</span><span class="special">;</span>
    <span class="identifier">log_error_impl</span><span class="special">(</span><span class="identifier">tail</span><span class="special">...);</span>
<span class="special">}</span>

<span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">class</span><span class="special">...</span> <span class="identifier">Args</span><span class="special">&gt;</span>
<span class="keyword">void</span> <span class="identifier">log_error</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">Args</span><span class="special">&amp;...</span> <span class="identifier">args</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">static</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">mutex</span> <span class="identifier">mtx</span><span class="special">;</span>

    <span class="comment">// Acquire the mutex, then write the passed arguments to std::cerr.</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">unique_lock</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">mutex</span><span class="special">&gt;</span> <span class="identifier">lock</span><span class="special">(</span><span class="identifier">mtx</span><span class="special">);</span>
    <span class="identifier">log_error_impl</span><span class="special">(</span><span class="identifier">args</span><span class="special">...);</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
<span class="special">}</span>

<span class="special">}</span>  <span class="comment">// namespace notes</span>
</pre>
</div>
<div class="copyright-footer">Copyright © 2019-2023 Ruben Perez<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="pipeline.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../examples.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="../tests.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
